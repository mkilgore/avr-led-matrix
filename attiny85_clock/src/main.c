
#include "common.h"
#include "usi_i2c_master.h"
#include "snes_classic.h"

#include <avr/interrupt.h>
#include <avr/pgmspace.h>

#include <string.h>

#define I2C_ADDRESS 0x2A

#define ROR(S,i) (((S)>>(i)) | ((S)<<(8-(i))))
#define ROL(S,i) (((S)<<(i)) | ((S)>>(8-(i))))

uint8_t buf[34] = {
    0x00,
    0b00111100,
    0b01000010,
    0b10100101,
    0b10000001,
    0b10100101,
    0b10011001,
    0b01000010,
    0b00111100,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0b00000000,
    0x01,
};

uint8_t digit_index = 0;

const PROGMEM uint8_t animation[][8] = {
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b10000000,
        0b10000000,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b11000000,
        0b11000000,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b01100000,
        0b01100000,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00110000,
        0b00110000,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00001100,
        0b00001100,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00000110,
        0b00000110,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00000011,
        0b00000011,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00000001,
        0b00000001,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00000011,
        0b00000011,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00000110,
        0b00000110,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00001100,
        0b00001100,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b00110000,
        0b00110000,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b01100000,
        0b01100000,
        0b00000000,
        0b00000000,
        0b11111111
    },
    {
        0b11111111,
        0b00000000,
        0b00000000,
        0b11000000,
        0b11000000,
        0b00000000,
        0b00000000,
        0b11111111
    },
};


const PROGMEM uint8_t animation2[][8] = {
    {
        0b00000000,
        0b00000000,
        0b00000000,
        0b00011000,
        0b00011000,
        0b00000000,
        0b00000000,
        0b00000000,
    },
    {
        0b00000000,
        0b00000000,
        0b00111100,
        0b00100100,
        0b00100100,
        0b00111100,
        0b00000000,
        0b00000000,
    },
    {
        0b00000000,
        0b01111110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111110,
        0b00000000,
    },
    {
        0b11111111,
        0b10000001,
        0b10000001,
        0b10000001,
        0b10000001,
        0b10000001,
        0b10000001,
        0b11111111,
    },
    {
        0b00000000,
        0b01111110,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01000010,
        0b01111110,
        0b00000000,
    },
    {
        0b00000000,
        0b00000000,
        0b00111100,
        0b00100100,
        0b00100100,
        0b00111100,
        0b00000000,
        0b00000000,
    },
};

int main(void)
{
    DDRB &= ~_BV(DDB3);
    DDRB |= _BV(DDB1);

    usi_twi_master_initialize();
    snes_classic_init();

    sei();

    PORTB |= _BV(PORTB1);

    while (1) {
        while (PINB & _BV(PINB3))
            ;

        usi_twi_write_data(I2C_ADDRESS, buf, sizeof(buf) / sizeof(*buf));
        PORTB ^= _BV(PORTB1);

        _delay_ms(100);

        digit_index = (digit_index + 1) % ARRAY_SIZE(animation2);
        int i = 0;

        for (i = 0; i < 8; i++) {
            uint8_t val = pgm_read_byte(&animation2[digit_index][i]);
            memset(buf + 1 + i * 4, val, 1);
        }
    }

    return 0;
}

